<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .container {
        max-width: 600px;
        margin-top: 50px;
      }
      #video {
        width: 100%;
        border: 2px solid #ccc;
        display: none;
      }
      #result {
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
      }
      #timer {
        margin-top: 10px;
        font-size: 16px;
        color: green;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="text-center">QR Code Scanner</h2>

      <div class="text-center">
        <button id="startButton" class="btn btn-primary">Start Camera</button>
      </div>

      <div class="text-center">
        <video id="video" autoplay playsinline></video>
      </div>

      <div id="result" class="text-center">Click "Start Camera" to begin!</div>
      <div id="timer" class="text-center">Time: 0.00s</div>
    </div>

    <script>
      // Elements
      const videoElement = document.getElementById("video");
      const resultElement = document.getElementById("result");
      const timerElement = document.getElementById("timer");
      const startButton = document.getElementById("startButton");

      let startTime;
      let stream = null;
      let animationFrameId = null;

      // Start camera function
      async function startCamera() {
        try {
          // Reset UI for a new scan
          resultElement.textContent = "Scanning...";
          timerElement.textContent = "Time: 0.00s";
          startButton.disabled = true;

          // Check for existing stream and stop it
          if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
          }

          // Request new video stream
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
            },
          });
          videoElement.srcObject = stream;
          videoElement.style.display = "block";
          videoElement.play(); // Start playing the video stream
          scanQRCode();
        } catch (error) {
          resultElement.textContent =
            "Unable to access camera. Permission denied or no camera found.";
          startButton.disabled = false;
          console.error("Camera access error:", error);
        }
      }

      // Scan QR Code and show result
      function scanQRCode() {
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        function tick() {
          if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
            if (!startTime) {
              startTime = performance.now();
            }

            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(imageData.data, canvas.width, canvas.height, {
              inversionAttempts: "dontInvert",
            });

            if (code) {
              const elapsedTime = (
                (performance.now() - startTime) /
                1000
              ).toFixed(2);
              resultElement.textContent = `QR Code Data: ${code.data}`;
              timerElement.textContent = `Time: ${elapsedTime}s`;
              stopCamera();
              startButton.disabled = false; // Re-enable the button
            } else {
              animationFrameId = requestAnimationFrame(tick);
            }
          } else {
            animationFrameId = requestAnimationFrame(tick);
          }
        }
        animationFrameId = requestAnimationFrame(tick);
      }

      // Stop the camera
      function stopCamera() {
        if (stream) {
          const tracks = stream.getTracks();
          tracks.forEach((track) => track.stop());
          videoElement.style.display = "none";
          videoElement.srcObject = null;
        }
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        }
      }

      // Button click event to start the camera
      startButton.addEventListener("click", () => {
        startTime = null; // Reset startTime for a new scan
        startCamera();
      });
    </script>
  </body>
</html>
