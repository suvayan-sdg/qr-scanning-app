<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .container {
        max-width: 600px;
        margin-top: 50px;
      }
      #video {
        width: 100%;
        border: 2px solid #ccc;
        display: none;
      }
      #result {
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
      }
      #timer {
        margin-top: 10px;
        font-size: 16px;
        color: green;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="text-center">QR Code Scanner</h2>

      <!-- Button to start the camera -->
      <div class="text-center">
        <button id="startButton" class="btn btn-primary">Start Camera</button>
      </div>

      <div class="text-center">
        <video id="video" autoplay></video>
      </div>

      <div id="result" class="text-center">Scan a QR code!</div>
      <div id="timer" class="text-center">Time: 0.00s</div>
    </div>

    <script>
      // Elements
      const videoElement = document.getElementById("video");
      const resultElement = document.getElementById("result");
      const timerElement = document.getElementById("timer");
      const startButton = document.getElementById("startButton");

      let startTime;
      let scanningInProgress = false;
      let stream = null; // To hold the video stream so we can stop it later

      // Start camera function
      async function startCamera() {
        try {
          // Check if there is an active stream, and stop it if necessary
          if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop()); // Stop all the tracks
          }

          // Request new video stream
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });

          videoElement.srcObject = stream;
          videoElement.style.display = "block"; // Show video element
          scanQRCode();
        } catch (error) {
          resultElement.textContent = "Unable to access camera!";
          console.error(error);
        }
      }

      // Scan QR Code and show result
      function scanQRCode() {
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        function scan() {
          if (
            videoElement.readyState === videoElement.HAVE_ENOUGH_DATA &&
            !scanningInProgress
          ) {
            if (!startTime) startTime = performance.now(); // Start timer when scanning begins
            scanningInProgress = true; // Prevent multiple scans

            // Capture the video frame
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            // Decode the QR code
            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(imageData.data, canvas.width, canvas.height);

            if (code) {
              const elapsedTime = (
                (performance.now() - startTime) /
                1000
              ).toFixed(2); // Calculate time in seconds
              resultElement.textContent = `QR Code Data: ${code.data}`;
              timerElement.textContent = `Time: ${elapsedTime}s`;
              scanningInProgress = false; // Reset scanning flag
            }
          }
          requestAnimationFrame(scan);
        }

        scan();
      }

      // Button click event to start the camera
      startButton.addEventListener("click", () => {
        startButton.disabled = true; // Disable button after click to prevent multiple presses
        startCamera();
      });
    </script>
  </body>
</html>
